const { remote, ipcRenderer } = require('electron')

require('devtron').install()

let modules = remote.getGlobal('modules'),
	AccentColor = '#' + remote.systemPreferences.getAccentColor().substr(0, 6)

remote.systemPreferences.on('accent-color-changed', (event, color) => {
	AccentColor = color.substr(0, 6)
	$(':root').css('--AccentColor', AccentColor)
	for (m in modules) {
		document.querySelector(`webview[name="${modules[m].name.toLowerCase()}"]`).send('!AccentColor', AccentColor)
	}
})

function addtab(name, path) {
	$('#tabs').append(`<li>${name}</li>`)
	$('body').append(`<webview src="../../${path}/index.html" name="${name.toLowerCase()}" class="hide" nodeintegration>`)

	console.log('added', name, path)

	let webview = document.querySelector(`webview[name="${name.toLowerCase()}"]`)

	webview.addEventListener('dom-ready', () => {
		webview.openDevTools() // $0.openDevTools()
		webview.send('!AccentColor', AccentColor)
	})

	webview.addEventListener('ipc-message', (e) => {
		ipcRenderer.send(e.channel.toLowerCase(), e.args[0])
	})
}

function changetab(name) {
	$('#tabs li').removeClass('selected')
	$(`#tabs li:contains('${name}')`).addClass('selected')
	$('webview').addClass('hide')
	$(`webview[name="${name.toLowerCase()}"]`).removeClass('hide')
}

jQuery(($) => {
	$(':root').css('--AccentColor', AccentColor)

	for (m in modules) {
		addtab(modules[m].name, modules[m].path)
	}

	ipcRenderer.on('add', (event, name, path) => {
		addtab(name, path)
		modules[name.toLowerCase()] = { name, path }
	})

	ipcRenderer.on('remove', (event, name) => {
		delete modules[name.toLowerCase()]
		$(`#tabs li:contains('${name}')`).remove()
		$(`webview[name="${name.toLowerCase()}"]`).remove()
		console.log('removed', name)
	})

	$('#tabs').on('click', 'li', function () {
		changetab($(this).text())
	})

	ipcRenderer.on('show', (event, name) => {
		changetab(name)
	})

	ipcRenderer.on('send', (event, name, channel, ...args) => {
		document.querySelector(`webview[name="${name.toLowerCase()}"]`).send(name, channel.toString(), ...args)
	})

})